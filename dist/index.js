var P=Object.create;var f=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var E=t=>f(t,"__esModule",{value:!0});var F=(t,e)=>{E(t);for(var o in e)f(t,o,{get:e[o],enumerable:!0})},D=(t,e,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of j(e))!A.call(t,n)&&n!=="default"&&f(t,n,{get:()=>e[n],enumerable:!(o=$(e,n))||o.enumerable});return t},g=t=>D(E(f(t!=null?P(K(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var N=(t,e,o)=>{if(!e.has(t))throw TypeError("Cannot "+o)};var i=(t,e,o)=>(N(t,e,"read from private field"),o?o.call(t):e.get(t)),b=(t,e,o)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,o)},O=(t,e,o,n)=>(N(t,e,"write to private field"),n?n.call(t,o):e.set(t,o),o);var v=(t,e,o)=>(N(t,e,"access private method"),o);F(exports,{default:()=>C});var c=g(require("@serverless-devs/core"));var p=g(require("@serverless-devs/core")),l=class{static setContent(e){l.CONTENT=e}static log(e,o){p.Logger.log(e,o)}static info(e){p.Logger.info(l.CONTENT,e)}static debug(e){p.Logger.debug(l.CONTENT,e)}static error(e){p.Logger.error(l.CONTENT,e)}static warning(e){p.Logger.warn(l.CONTENT,e)}static success(e){p.Logger.log(e,"green")}},m=l;m.CONTENT="COMPONENT";var h=g(require("@kubernetes/client-node")),y=g(require("@serverless-devs/core")),u,r,d,T,w=class{constructor(e){b(this,d);b(this,u,void 0);b(this,r,void 0);O(this,u,new h.KubeConfig),e?i(this,u).loadFromFile(e):i(this,u).loadFromDefault(),O(this,r,h.KubernetesObjectApi.makeApiClient(i(this,u)))}async apply(e){let o=await v(this,d,T).call(this,e),n=[];for(let s of o){s.metadata=s.metadata||{},s.metadata.annotations=s.metadata.annotations||{},delete s.metadata.annotations["kubectl.kubernetes.io/last-applied-configuration"],s.metadata.annotations["kubectl.kubernetes.io/last-applied-configuration"]=JSON.stringify(s);try{await i(this,r).read(s);let a=await i(this,r).patch(s);n.push(a.body)}catch{let k=await i(this,r).create(s);n.push(k.body)}}return n}async delete(e){let o=await v(this,d,T).call(this,e);for(let n of o)await i(this,r).delete(n)}};u=new WeakMap,r=new WeakMap,d=new WeakSet,T=async function(e){let o=await y.fse.promises.readFile(e,"utf8");return y.jsyaml.loadAll(o).filter(s=>s&&s.kind&&s.metadata)};var M=[{header:"ofn component",content:"You can use the component to manage your OpenFunction source and function custom resources."},{header:"Usage",content:"$ s <command> <options>"},{header:"Command List",content:[{name:"help",summary:"Display help information."},{name:"build",summary:"Build function image locally with pack tool."},{name:"deploy",summary:"Deploy or remove the function over target Kubernetes context."}]},{header:"Examples",content:[{desc:"1. A build example. ",example:"$ s ofn build"},{desc:"2. A deploy example. ",example:"$ s ofn deploy"},{desc:"3. A remove example. ",example:"$ s ofn deploy delete"}]},{content:"Project home: {underline https://github.com/openfunction/serverless-devs}"}],x={COMPONENT:M};var C=class{async build(e){let{src:o,builder:n,env:s}=e.props||{},a=await c.inquirer.prompt([{type:"input",name:"builder",message:"Which builder to use?",default:n},{type:"input",name:"function",message:"Which function to invoke?",default:s.FUNC_NAME},{type:"confirm",name:"production",message:"Is this for produnction?",default:s.NODE_ENV==="production"},{type:"input",name:"image",message:"What's the output image? (e.g. 'image:tag' or 'repository/image:tag')"}]);await c.execa.command(["pack build -v",`-p ${o}`,`-B ${a.builder}`,`-e FUNC_NAME=${a.function}`,`-e NODE_ENV=${a.production?"production":"dev"}`,a.image].join(" "))}async deploy(e){let n=e.argsObj.includes("delete")?"delete":"apply",s=await c.inquirer.prompt([{type:"input",name:"kubeconfig",message:"Which kubeconfig to use? (Leave empty to use default)"},{type:"input",name:"function",message:`Which function to ${n}?`,default:e.props.function}]);m.info(`Function to ${n}: ${s.function}`);let{confirmed:a}=await c.inquirer.prompt([{type:"confirm",name:"confirmed",message:`Are you confirmed to ${n} function?`,default:!1}]);if(!a)return;await new w(s.kubeconfig)[n](s.function)}help(){(0,c.help)(x.COMPONENT)}};0&&(module.exports={});
